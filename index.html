<!DOCTYPE html>
<html>
<head>
<title>Jackiequest: Wyvern battle</title>
<style>
body {
  background-image: url('skybox.png');
    background-repeat: no-repeat;
  background-attachment: fixed;
  background-size: cover;
}

.army td, th {  
	text-align: right;
	border:3px solid black;
	padding:5px;
	margin:5px;
}
.army img{
	width: 160px;
}

#log td, th{  
	text-align: center;
}

</style>
</head>

<script>
var fighter=["Fighter",20,3,"Slashes"]
var ranger=["Ranger",15,5,"Shoots"]
var mage=["Mage",10,7,"Firebolts"]
var cleric=["Cleric",10,-3,"Heals"]

var arrayEmpty = new Array(6);
var enemies = [
  ["Blade birdling", 10, 10, 6, "Pecks"],         
  ["Eye puddle", 9, 9, 7, "Lasers"],              
  ["Shield", 20, 20, 3, "Rams"],                  
  ["Hydra seal", 12, 12, -3, "Charms"],           
  ["Bat larva", 12, 12, 5, "Screeches"],          
  ["Bearcub blob", 15, 15, 4, "Mauls"],           
  ["Bug cannon", 8, 8, 8, "Shoots"],              
  ["Croc ball", 10, 10, 6, "Bites"],              
  ["Fox floof", 9, 9, 7, "Pounces"],              
  ["Small blobdragon", 6, 6, 10, "Ignites"],
  ["Kobold", 12, 12, 5, "Stabs"],           
  ["Lava worm", 7, 7, 9, "Burns"],          
  ["Nest bit", 10, 10, 6, "Nips"],          
  ["Sand ant", 10, 10, 6, "Gnaws"],         
  ["Tree saurling", 15, 15, 4, "Swipes"],   
]
var partySlots=[["Mage",10,10,7,"Firebolts"],["Ranger",15,15,5,"Shoots"],["Healer",10,10,-3,"Heals"],["Fighter",20,20,3,"Slashes"],["Mage",10,10,7,"Firebolts"],["Ranger",15,15,5,"Shoots"]]
var hireSlots=[["Mage",10,10,7,"Firebolts"],["Ranger",15,15,5,"Shoots"],["Healer",10,10,-3,"Heals"],["Fighter",20,20,3,"Slashes"],["Paladin",30,30,-1,"Rallies"],["Druid",12,12,6,"Claws"]]
var enemySlots=[[],[],[],[],[],[]] <!-- =
len=partySlots.length
var selected_slot=0

function hire_units() {
	for (let i = 0; i < len; i++){

			document.getElementById("enemy_"+(i+1)+"_image").innerHTML="<img style='transform: scaleX(-1);' src='"+hireSlots[i][0]+".png' onclick=replace("+(i)+")>"
			document.getElementById("enemy_"+(i+1)).innerHTML= ("<progress value="+hireSlots[i][1]+" max="+hireSlots[i][2]+"></progress><br>"+hireSlots[i][0]+" "+hireSlots[i][1]+"/"+hireSlots[i][2]+", ")
			
			if (hireSlots[i][3]>0)
			{
				document.getElementById("enemy_"+(i+1)).innerHTML+=hireSlots[i][3]+" dmg"
			} else {
				document.getElementById("enemy_"+(i+1)).innerHTML+=-hireSlots[i][3]+" heal"
			}
	}
}
function replace(incoming) {
	partySlots[selected_slot-1]=hireSlots[incoming]
	console.log("replacement! "+incoming)
	document.getElementById("player_"+(selected_slot)+"_image").innerHTML="<img src='"+partySlots[selected_slot-1][0]+".png' onclick=replace("+(selected_slot-1)+")>"
	
 	document.getElementById("player_"+(selected_slot)).innerHTML= ("<progress value="+partySlots[selected_slot-1][1]+" max="+partySlots[selected_slot-1][2]+"></progress><br><a id=player_"+(selected_slot)+"_name onclick='rename("+(selected_slot+1)+")'>"+partySlots[selected_slot-1][0]+"</a> "+partySlots[selected_slot-1][1]+"/"+partySlots[selected_slot-1][2]+", ")
	if (partySlots[selected_slot-1][2]>0) { document.getElementById("player_"+selected_slot).innerHTML+=partySlots[selected_slot-1][3]+" dmg"
	} else { 
	document.getElementById("player_"+selected_slot).innerHTML+=-partySlots[selected_slot-1][3]+" heal"
	}
	
}

function select(index) {
	console.log("fucking index is "+index+" and selected slot is "+selected_slot)
	if (index==selected_slot) {
		document.getElementById("player_"+index+"_image").style.borderWidth = '1px';
		selected_slot=0
	} else {
		selected_slot=index
		document.getElementById("player_1_image").style.borderWidth = '1px'
		document.getElementById("player_2_image").style.borderWidth = '1px'
		document.getElementById("player_3_image").style.borderWidth = '1px'
		document.getElementById("player_4_image").style.borderWidth = '1px'
		document.getElementById("player_5_image").style.borderWidth = '1px'
		document.getElementById("player_6_image").style.borderWidth = '1px'
			
		document.getElementById("player_"+index+"_image").style.borderWidth = '5px';
	}
	console.log("selected slot has become "+selected_slot)
}

function get_total_health(team) {
	total_health=0
	console.log("total health")
	for(let i=0;i<team.length;i++) {
		total_health+=team[i][1]
	}
	return total_health
}

function startup() {
	for (let i = 0; i < len; i++){
		document.getElementById("player_"+(i+1)).innerHTML= ("<progress value="+partySlots[i][1]+" max="+partySlots[i][2]+"></progress><br><a id=player_"+(i+1)+"_name onclick='rename("+(i+1)+")'>"+partySlots[i][0]+"</a> "+partySlots[i][1]+"/"+partySlots[i][2]+", ")
		if (partySlots[i][2]>0)
		{
			document.getElementById("player_"+(i+1)).innerHTML+=partySlots[i][3]+" dmg"
		} else {
			document.getElementById("player_"+(i+1)).innerHTML+=-partySlots[i][3]+" heal"
		}
		
		var random_enem_i = Math.floor(Math.random() * enemies.length);
		enemySlots[i]=enemies[random_enem_i].slice()
		document.getElementById("enemy_"+(i+1)+"_image").innerHTML="<img src='"+enemySlots[i][0]+".png'>"
		document.getElementById("enemy_"+(i+1)).innerHTML= ("<progress value="+enemySlots[i][1]+" max="+enemySlots[i][2]+"></progress><br>"+enemySlots[i][0]+" "+enemySlots[i][1]+"/"+enemySlots[i][2]+", ")
		
		if (enemySlots[i][3]>0)
		{
			document.getElementById("enemy_"+(i+1)).innerHTML+=enemySlots[i][3]+" dmg"
		} else {
			document.getElementById("enemy_"+(i+1)).innerHTML+=-enemySlots[i][3]+" heal"
		}
	}
}
function rename(id)
{
	<!-- console.log(partySlots[id-1])
	new_name = prompt("Rename "+partySlots[id-1][0]);
	if (len(new_name)>0) {
		document.getElementById("player_"+(id)+"_name").innerHTML = new_name
		partySlots[id-1] = new_name
	}
}

function get_target(target_slots,slot_numbers)
{
	for (let i = 0; i < slot_numbers.length; i++) 
	{
		<!-- console.log("attempt #"+(i+1)+". checking if "+target_slots[slot_numbers[i]][0]+" has hit points (has "+target_slots[slot_numbers[i]][1]+"). priorities: "+slot_numbers) -->
		if (target_slots[slot_numbers[i]][1]>0)
		{
			return slot_numbers[i]
		}
	}
	return slot_numbers[slot_numbers.length-1]
}
var winner="nobody"
async function start_battle()
{
	var table = document.getElementById("log");
	battle(function() {
			console.log(winner+" wins!");
			var row = table.insertRow(-1);
			var cell = row.insertCell(0); 
			cell.innerHTML=("<b>"+winner+" wins!</b>")
		}); 
}


async function battle(_callback) {
	var table = document.getElementById("log");
	document.getElementById("start_button").remove();
	document.getElementById("hire_button").remove();
	var party_health_max=get_total_health(partySlots)
	var enemy_health_max=get_total_health(enemySlots)
	var round=1
	var max_rounds=3
		for (let i = 0; round <= max_rounds; i++) {
		if (i>=len)
		{
			i-=len
			round+=1
		}
		setTimeout(function() {
			var member=partySlots[i]
			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
			if (member[3]<0)
			{
				var min=999
				var mindex=0
				for (let j = 0; j < len; j++) {
					if (partySlots[j][1]<min && partySlots[j][1]>0) {
						min=partySlots[j][1]
						mindex=j
					}
				}
				partySlots[mindex][1]=(partySlots[mindex][1]-member[3])
				
				if (partySlots[mindex][1]>partySlots[mindex][2]) {partySlots[mindex][1]=partySlots[mindex][2]}
				document.getElementById("player_"+(mindex+1)).innerHTML= ("<progress value="+partySlots[mindex][1]+" max="+partySlots[mindex][2]+"></progress><br><a id=player_"+(mindex+1)+"_name onclick='rename("+(mindex+1)+")'>"+partySlots[mindex][0]+"</a> "+partySlots[mindex][1]+"/"+partySlots[mindex][2]+", "+partySlots[mindex][3]+" dmg")
				cell1.innerHTML = member[0]+" "+member[4]+" "+partySlots[mindex][0]+" for "+-member[3]+" health!";
			} else {
				var target=0
				if (i<2) { 
					target=get_target(enemySlots,[0,1,2,3,4,5])
				} else if (i<4) {
					target=get_target(enemySlots,[2,3,0,1,4,5])
				} else {
					target=get_target(enemySlots,[4,5,2,3,0,1])
				}
				cell1.innerHTML = member[0]+" "+member[4]+" "+enemySlots[target][0]+" for "+member[3]+" damage!";
				enemySlots[target][1]=enemySlots[target][1]-member[3]
				if (enemySlots[target][1]<0) {enemySlots[target][1]=0}
				document.getElementById("enemy_"+(target+1)).innerHTML= ("<progress value="+enemySlots[target][1]+" max="+enemySlots[target][2]+"></progress><br>"+enemySlots[target][0]+" "+enemySlots[target][1]+"/"+enemySlots[target][2]+", "+enemySlots[target][3]+" dmg")
			}
			enemy_health=get_total_health(enemySlots)	
			console.log("Enemy health: "+enemy_health+"/"+enemy_health_max)
			if (enemy_health==0) {
				winner="party"
				_callback();   
				return
			}
			
			setTimeout(function() {
			var row = table.insertRow(-1);
			var monster=enemySlots[i]
			var cell1 = row.insertCell(0);
			
			if (monster[3]<0)
			{
				cell1.innerHTML = monster[0]+" "+monster[4]+" another monster for "+-monster[3]+" health!";
			} else {
				cell1.innerHTML = monster[0]+" "+monster[4]+" a hero for "+monster[3]+" damage!";
				
				var target=0
				if (i<2) { 
					target=get_target(partySlots,[1,0,3,2,5,4])
				} else if (i<4) {
					target=get_target(partySlots,[3,2,1,0,5,4])
				} else {
					target=get_target(partySlots,[5,4,1,0,3,2])
				}
				cell1.innerHTML = monster[0]+" "+monster[4]+" "+partySlots[target][0]+" for "+monster[3]+" damage!";
				partySlots[target][1]=partySlots[target][1]-monster[3]
				if (partySlots[target][1]<0) {partySlots[target][1]=0}
				document.getElementById("player_"+(target+1)).innerHTML= ("<progress value="+partySlots[target][1]+" max="+partySlots[target][2]+"></progress><br>"+partySlots[target][0]+" "+partySlots[target][1]+"/"+partySlots[i][2]+", "+partySlots[target][3]+" dmg")
			}
			},500)
			
			party_health=get_total_health(partySlots)
			console.log("Party health: "+party_health+"/"+party_health_max)
			if (party_health==0) {
				console.log("the party dies...")
				winner="enemy"
				_callback();
				return
			}
			
			},1000*(i+((round-1)*len)))
		}
}

</script>

<body onload="startup()">

<div style="width: 100%; display: table; height:100%;padding-top:4%">
    <table style="display: table-row;width: 90%" ><tr>
        <td style="outline: 0px solid grey; width: 2.5%; display: table-cell; padding:50px; margin: 50px;"> </td> <!-- left padding-->
        <td style="outline: 0px solid pink; width: 25%; display: table-cell; padding:50px; margin: 50px;">
		<table id="player" class="army" style="background-color:lightgrey; float:left; border-collapse: collapse;">
		<tr><th style="font-size:24px;text-align:center" colspan="4">Player</th></tr>
		<tr>
		<td id="player_1_image" style="border: 1px solid black"><img src="mage.png" onclick="select(1)">
		<td id="player_2_image" style="border: 1px solid black"><img src="ranger.png" onclick="select(2)">
		<tr>
		<td id="player_1">
		<td id="player_2">
		<tr>
		<td id="player_3_image" style="border: 1px solid black"><img src="healer.png" onclick="select(3)">
		<td id="player_4_image" style="border: 1px solid black"><img src="fighter.png" onclick="select(4)">
		<tr>
		<td id="player_3">
		<td id="player_4">
		<tr>
		<td id="player_5_image" style="border: 1px solid black"><img src="mage.png" onclick="select(5)">
		<td id="player_6_image" style="border: 1px solid black"><img src="ranger.png" onclick="select(6)">
		<tr>
		<td id="player_5">
		<td id="player_6">
		
		</table>
		
		</td> <!-- pet -->
        <td style="outline: 0px solid grey; width: 25%; display: table-cell; padding:50px; margin: 50px;">
		<table id="log" style="background-color:lightgrey;  border-collapse: collapse; width: 90% ">
		<tr><th style="font-size:24px;text-align:center" colspan="2">Event log</th></tr>
		<tr>
		<th onclick="start_battle()" id="start_button">Start battle
		<th onclick="hire_units()" id="hire_button">Hire Units
		</table><br>
		</td> <!-- center padding-->
        
		<td style="outline: 0px solid yellow; width: 25%;display: table-cell; padding:50px; margin: 50px;">
		<table id="enemy" class="army" style="background-color:lightgrey; float:left; border-collapse: collapse;">
		<tr><th style="font-size:24px;text-align:center" colspan="2">Enemy</th></tr>
		<tr>
		<td id="enemy_1_image">
		<td id="enemy_2_image">
		<tr>
		<td id="enemy_1">
		<td id="enemy_2">
		<tr>
		<td id="enemy_3_image">
		<td id="enemy_4_image">
		<tr>
		<td id="enemy_3">
		<td id="enemy_4">
		<tr>
		<td id="enemy_5_image">
		<td id="enemy_6_image">
		<tr>
		<td id="enemy_5">
		<td id="enemy_6">
		
		</table>
		
		</td> 
        <td style="outline: 0px solid grey; width: 2.5%; display: table-cell; padding:50px; margin: 50px;"> </td> <!-- right padding-->
    </div>
</div>

</body>
</html>

